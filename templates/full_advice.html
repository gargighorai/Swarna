{% extends "base.html" %}

{% block content %}

<div class="container mt-4">
  <h5 class="mb-3 text-center bg-primary text-white">Full Advice {{patient.name}}</h5>

  <form method="POST" action="{{ url_for('save_advice', patient_id=patient.id) }}">
   

    <!-- Drug selection -->
    <div class="row">
      <!-- Prescribed drugs (left) -->
      <div class="col-md-6 bg-earning">
        <h6>Prescribed Drugs</h6>
        <ul id="prescribed-drugs" class="list-unstyled small bg-primary-subtle"></ul>
        <input type="hidden" name="drugs" id="drugs-input">
      </div>

      <!-- Available drugs (right) -->
      <div class="col-md-6">
        <h6>Available Drugs</h6>

        <div id="available-drugs" class="small"></div>
      </div>
    </div>
 <!-- Advice textarea -->
    <div class="mb-3">
      <label for="advice" class="form-label">Advice</label>
      <textarea name="advice" id="advice" class="form-control small" rows="2" required></textarea>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-success">Save Advice</button>
    </div>
  </form>
</div>

<!-- Script -->
<script>
  let prescribed = [];

  function renderPrescribed() {
    const list = document.getElementById("prescribed-drugs");
    list.innerHTML = "";
    prescribed.forEach((drug, index) => {
      const li = document.createElement("li");
      li.textContent = drug;
      li.classList.add("mb-1");
      li.onclick = () => removeDrug(index);
      list.appendChild(li);
    });
    document.getElementById("drugs-input").value = JSON.stringify(prescribed);
  }

  function addDrug(name) {
    if (!prescribed.includes(name)) {
      prescribed.push(name);
      renderPrescribed();
    }
  }

  function removeDrug(index) {
    prescribed.splice(index, 1);
    renderPrescribed();
  }

  // Load available drugs from static JSON
  fetch("/static/drugs.json")
    .then(response => {
      if (!response.ok) {
        throw new Error("Failed to load drugs.json");
      }
      return response.json();
    })
    .then(data => {
      const availableDiv = document.getElementById("available-drugs");
      availableDiv.innerHTML = "";
      data.forEach(drug => {
        const div = document.createElement("div");
        div.textContent = drug.name;
        div.classList.add("cursor-pointer", "hover:text-primary", "mb-1");
        div.onclick = () => addDrug(drug.name);
        availableDiv.appendChild(div);
      });
    })
    .catch(err => {
      console.error("Error loading drugs:", err);
    });
</script>

{% endblock %}
